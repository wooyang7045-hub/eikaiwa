
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AIè‹±ä¼šè©±é“å ´">
  <title>AIè‹±ä¼šè©±é“å ´</title>
  <style>
    :root {
      --bg:#0f0f1a; --card:#1a1a2e; --accent:#e94560; --accent2:#f5a623;
      --blue:#3a86ff; --green:#27ae60; --text:#eeeef0; --muted:#8888aa;
      --bubble-me:#0f3460; --bubble-ai:#2d1b69; --border:#2a2a4a;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,'Hiragino Sans',sans-serif;}

    .screen{display:none;}
    .screen.active{display:block;}

    /* ãƒ­ã‚°ã‚¤ãƒ³ */
    #screen-login{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;}
    #screen-login.active{display:flex;}
    .logo-area{text-align:center;margin-bottom:28px;}
    .logo-area .lg-emoji{font-size:4rem;display:block;margin-bottom:8px;}
    .logo-area h1{font-size:1.8rem;font-weight:900;color:var(--accent);}
    .logo-area p{font-size:0.85rem;color:var(--muted);margin-top:6px;}
    .login-box{width:100%;max-width:380px;}
    .login-box select{
      width:100%;padding:14px 16px;margin-bottom:12px;
      background:var(--card);color:var(--text);
      border:1px solid var(--border);border-radius:14px;
      font-size:1rem;appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right 16px center;
    }
    .login-box select option{background:#1a1a2e;}

    /* APIã‚­ãƒ¼å…¥åŠ› */
    #apiKeyBox{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;}
    #apiKeyBox p{font-size:0.8rem;color:var(--muted);margin-bottom:8px;}
    #apiKeyBox input{
      width:100%;padding:12px;background:#0f0f1a;color:var(--text);
      border:1px solid var(--border);border-radius:10px;font-size:0.9rem;
    }
    #apiKeyBox .api-tip{font-size:0.72rem;color:var(--muted);margin-top:6px;}
    #apiKeyBox .api-tip a{color:var(--blue);}

    /* ã‚¢ãƒã‚¿ãƒ¼é¸æŠ */
    #screen-avatar{padding:20px;max-width:480px;margin:0 auto;}
    #screen-avatar.active{display:block;}
    .sec-title{text-align:center;font-size:1.3rem;font-weight:800;color:var(--accent);margin-bottom:4px;}
    .sec-sub{text-align:center;font-size:0.8rem;color:var(--muted);margin-bottom:18px;}
    .avatar-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;}
    .av-card{
      background:var(--card);border:2px solid var(--border);border-radius:18px;
      padding:18px 12px;text-align:center;cursor:pointer;transition:0.15s;
    }
    .av-card:hover{border-color:#555;}
    .av-card.sel{border-color:var(--accent);background:#2a0d1e;}
    .av-card .av-em{font-size:3rem;line-height:1;}
    .av-card .av-nm{font-size:1rem;font-weight:700;margin-top:8px;}
    .av-card .av-fl{font-size:0.75rem;color:var(--muted);margin-top:3px;}
    .av-card .av-tr{font-size:0.7rem;color:var(--accent2);margin-top:4px;background:rgba(245,166,35,.12);border-radius:20px;padding:2px 8px;display:inline-block;}

    /* ãƒœã‚¿ãƒ³ */
    .btn{width:100%;padding:16px;border:none;border-radius:16px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:opacity .15s,transform .1s;}
    .btn:active{transform:scale(.97);}
    .btn-primary{background:var(--accent);color:white;}
    .btn-secondary{background:var(--card);color:var(--muted);border:1px solid var(--border);margin-top:10px;}

    /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
    #screen-chat{display:flex;flex-direction:column;height:100vh;}
    #screen-chat.active{display:flex;}
    #chatHeader{background:var(--card);padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);flex-shrink:0;}
    #chatHeader .hd-av{font-size:2.2rem;flex-shrink:0;}
    #chatHeader .hd-info h3{font-size:1rem;font-weight:700;}
    #chatHeader .hd-info p{font-size:0.72rem;color:var(--muted);}
    #endBtnTop{margin-left:auto;padding:8px 14px;background:var(--accent);color:white;border:none;border-radius:10px;font-size:0.82rem;font-weight:700;cursor:pointer;flex-shrink:0;}
    #statsBar{background:#0a0a14;padding:8px 16px;display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
    .st-item{flex:1;text-align:center;}
    .st-item .sv{font-size:1.3rem;font-weight:800;color:var(--accent2);display:block;line-height:1.2;}
    .st-item .sl{font-size:0.65rem;color:var(--muted);}
    .st-item+.st-item{border-left:1px solid var(--border);}
    #chatBox{flex:1;overflow-y:auto;padding:16px;scroll-behavior:smooth;}
    .bwrap{display:flex;margin-bottom:16px;gap:10px;align-items:flex-end;}
    .bwrap.me{flex-direction:row-reverse;}
    .bava{font-size:1.8rem;flex-shrink:0;}
    .bubble{max-width:78%;padding:12px 16px;border-radius:20px;line-height:1.75;font-size:0.95rem;word-break:break-word;}
    .bubble.ai{background:var(--bubble-ai);border-bottom-left-radius:4px;}
    .bubble.me{background:var(--bubble-me);border-bottom-right-radius:4px;}
    .wbtn{display:inline;background:none;border:none;color:inherit;cursor:pointer;padding:0 1px;font-size:inherit;font-family:inherit;text-decoration:underline dotted rgba(255,255,255,.4);width:auto;}
    .wbtn:hover{color:var(--accent2);}
    .transl{display:inline-block;background:var(--accent2);color:#1a1000;font-size:.72rem;padding:2px 9px;border-radius:20px;margin-left:4px;font-weight:700;vertical-align:middle;animation:popIn .2s ease;}
    @keyframes popIn{from{transform:scale(.6);opacity:0;}to{transform:scale(1);opacity:1;}}
    .word-badge{font-size:.68rem;color:var(--muted);margin-top:5px;}
    .bubble.loading-dots{padding:14px 18px;}
    .dot{display:inline-block;width:7px;height:7px;background:var(--muted);border-radius:50%;margin:0 2px;animation:bounce 1.2s infinite;}
    .dot:nth-child(2){animation-delay:.2s;}.dot:nth-child(3){animation-delay:.4s;}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);}40%{transform:translateY(-8px);}}
    #liveText{flex-shrink:0;min-height:44px;background:#08080f;padding:10px 16px;font-size:.85rem;color:var(--blue);border-top:1px solid var(--border);border-left:3px solid var(--blue);}
    #inputBar{flex-shrink:0;display:flex;gap:10px;padding:10px 16px 16px;background:var(--card);border-top:1px solid var(--border);}
    #micBtn{flex:1;padding:16px;border:none;border-radius:16px;background:var(--green);color:white;font-size:1.05rem;font-weight:700;cursor:pointer;}
    #micBtn.rec{background:var(--accent);animation:pulse 1s infinite;}
    #micBtn:disabled{background:#444;opacity:.6;cursor:not-allowed;}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.65;}}

    /* çµæœç”»é¢ */
    #screen-result{padding:24px;max-width:420px;margin:0 auto;}
    #screen-result.active{display:block;}
    .result-card{background:var(--card);border-radius:20px;padding:28px 20px;text-align:center;margin-bottom:16px;}
    .result-card h2{color:var(--accent);font-size:1.4rem;margin-bottom:16px;}
    .res-emoji{font-size:3.5rem;margin:8px 0;}
    .res-comment{color:var(--muted);font-size:.9rem;margin:10px 0 20px;}
    .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:16px 0;}
    .stat-box{background:#0a0a14;border-radius:14px;padding:16px 8px;}
    .stat-box .sv{font-size:2rem;font-weight:800;color:var(--accent2);display:block;}
    .stat-box .sl{font-size:.7rem;color:var(--muted);margin-top:3px;display:block;}
    .rec-row{display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid var(--border);font-size:.85rem;}
    .rec-row span:last-child{color:var(--accent2);font-weight:700;}
    #chatBox::-webkit-scrollbar{width:4px;}
    #chatBox::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

    /* ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    #saveStatus{text-align:center;font-size:.8rem;padding:8px;color:var(--muted);}
  </style>
</head>
<body>

<!-- â‘  ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="screen-login" class="screen">
  <div class="logo-area">
    <span class="lg-emoji">ğŸ—£ï¸</span>
    <h1>AIè‹±ä¼šè©±é“å ´</h1>
    <p>AIã¨è‹±èªã§è©±ã—ã¦å®ŸåŠ›ã‚¢ãƒƒãƒ—ï¼</p>
  </div>
  <div class="login-box">

    <!-- APIã‚­ãƒ¼å…¥åŠ›æ¬„ -->
    <div id="apiKeyBox">
      <p>ğŸ”‘ Anthropic APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-..." autocomplete="off">
      <p class="api-tip">
        ã‚­ãƒ¼ã¯ <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ã§å–å¾—ã§ãã¾ã™ã€‚<br>
        â€» ã“ã®ãƒšãƒ¼ã‚¸ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
      </p>
    </div>

    <select id="gradeSel" onchange="loadClasses()">
      <option value="">ğŸ“š å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <select id="classSel" onchange="loadNames()" style="display:none;">
      <option value="">ğŸ« ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>
    <select id="nameSel" style="display:none;">
      <option value="">ğŸ‘¤ åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>

    <div id="loadStatus" style="text-align:center;color:var(--muted);padding:10px;font-size:.85rem;"></div>

    <button class="btn btn-primary" onclick="goToAvatarSelect()" style="margin-top:4px;">
      æ¬¡ã¸ â†’
    </button>
  </div>
</div>

<!-- â‘¡ ã‚¢ãƒã‚¿ãƒ¼é¸æŠç”»é¢ -->
<div id="screen-avatar" class="screen">
  <div style="padding-top:24px;">
    <div class="sec-title">ğŸ­ ä¼šè©±ç›¸æ‰‹ã‚’é¸ã¼ã†</div>
    <div class="sec-sub">å£°ã®ç¨®é¡ãƒ»æ€§æ ¼ãƒ»ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãŒå¤‰ã‚ã‚Šã¾ã™</div>
    <div class="avatar-grid" id="avatarGrid"></div>
    <button class="btn btn-primary" onclick="startConversation()">ä¼šè©±ã‚¹ã‚¿ãƒ¼ãƒˆï¼ğŸ¤</button>
    <button class="btn btn-secondary" onclick="showScreen('login')">â† æˆ»ã‚‹</button>
  </div>
</div>

<!-- â‘¢ ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
<div id="screen-chat" class="screen">
  <div id="chatHeader">
    <div class="hd-av" id="hdAvaIcon">ğŸ¤–</div>
    <div class="hd-info">
      <h3 id="hdAvaName">AI Partner</h3>
      <p id="hdAvaDesc">è‹±èªã§è©±ã—ã‹ã‘ã¦ã¿ã‚ˆã†ï¼</p>
    </div>
    <button id="endBtnTop" onclick="endSession()">çµ‚äº† ğŸ’¾</button>
  </div>
  <div id="statsBar">
    <div class="st-item"><span class="sv" id="stTurns">0</span><span class="sl">ã‚¿ãƒ¼ãƒ³</span></div>
    <div class="st-item"><span class="sv" id="stWords">0</span><span class="sl">èª</span></div>
    <div class="st-item"><span class="sv" id="stSessions">1</span><span class="sl">å›ç›®</span></div>
    <div class="st-item"><span class="sv" id="stMaxTurns">0</span><span class="sl">æœ€é«˜ã‚¿ãƒ¼ãƒ³</span></div>
  </div>
  <div id="chatBox"></div>
  <div id="liveText">ğŸ¤ ã€Œè©±ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è‹±èªã§è©±ã—ã¦ãã ã•ã„</div>
  <div id="inputBar">
    <button id="micBtn" onclick="handleMic()">ğŸ¤ è©±ã™</button>
  </div>
</div>

<!-- â‘£ çµæœç”»é¢ -->
<div id="screen-result" class="screen">
  <div style="padding-top:20px;">
    <div class="result-card">
      <h2>ğŸ‰ ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼</h2>
      <div class="res-emoji" id="rEmoji">ğŸŒ±</div>
      <p class="res-comment" id="rComment">--</p>
      <div class="stat-grid">
        <div class="stat-box"><span class="sv" id="rTurns">0</span><span class="sl">ã‚¿ãƒ¼ãƒ³æ•°</span></div>
        <div class="stat-box"><span class="sv" id="rWords">0</span><span class="sl">èªæ•°</span></div>
        <div class="stat-box"><span class="sv" id="rSessions">1</span><span class="sl">ç·´ç¿’å›æ•°</span></div>
      </div>
      <div class="rec-row"><span>ğŸ† æœ€é«˜ã‚¿ãƒ¼ãƒ³æ•°</span><span id="rMaxTurns">--</span></div>
      <div class="rec-row"><span>ğŸ“Š ç´¯è¨ˆèªæ•°</span><span id="rTotalWords">--</span></div>
    </div>
    <div id="saveStatus">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­â€¦</div>
    <button class="btn btn-primary" onclick="showScreen('login')">ã‚‚ã†ä¸€åº¦ç·´ç¿’ã™ã‚‹ ğŸ”„</button>
  </div>
</div>

<script>
// ============================================================
//  â–¼â–¼â–¼ ã“ã“ã ã‘æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// ============================================================

// GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã¨ãã®URL /exec ã§çµ‚ã‚ã‚‹ã‚‚ã®ï¼‰
var GAS_URL = "https://script.google.com/macros/s/AKfycbxU6kJMip1_rzfMyD3Q0bssA0lRNL_PytYPIXIkligEvBV1PjEiT8xJHUSpL3_CFi-l/exec";

// ============================================================
//  ã‚¢ãƒã‚¿ãƒ¼å®šç¾©
// ============================================================
var AVATARS = [
  { id:"uk_m",  emoji:"ğŸ§”ğŸ»", name:"James",  flag:"ğŸ‡¬ğŸ‡§ British Male",    trait:"çŸ¥çš„ãƒ»è½ã¡ç€ã„ãŸ",  lang:"en-GB", pitch:0.85, rate:0.82,
    system:"You are James, a friendly British English teacher for Japanese junior high students. Use British expressions occasionally (brilliant, cheers, lovely). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be warm and encouraging." },
  { id:"uk_f",  emoji:"ğŸ‘©ğŸ¼",  name:"Emma",   flag:"ğŸ‡¬ğŸ‡§ British Female",   trait:"å„ªã—ã„ãƒ»ä¸å¯§",     lang:"en-GB", pitch:1.2,  rate:0.82,
    system:"You are Emma, a kind British woman. Use British expressions (lovely, brilliant, quite right). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be friendly and supportive." },
  { id:"us_m",  emoji:"ğŸ‘¨ğŸ»",  name:"Mike",   flag:"ğŸ‡ºğŸ‡¸ American Male",   trait:"å…ƒæ°—ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼", lang:"en-US", pitch:0.9,  rate:0.88,
    system:"You are Mike, an energetic American guy. Use American expressions (awesome, cool, great job). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be enthusiastic." },
  { id:"us_f",  emoji:"ğŸ‘±ğŸ»â€â™€ï¸", name:"Sarah",  flag:"ğŸ‡ºğŸ‡¸ American Female",  trait:"æ˜ã‚‹ã„ãƒ»ãƒã‚¸ãƒ†ã‚£ãƒ–", lang:"en-US", pitch:1.1,  rate:0.88,
    system:"You are Sarah, an upbeat American girl. Use American expressions (totally, amazing, awesome). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be cheerful." },
  { id:"au_m",  emoji:"ğŸ§‘ğŸ½",  name:"Liam",   flag:"ğŸ‡¦ğŸ‡º Australian Male",  trait:"ã®ã‚“ã³ã‚Šãƒ»æ°—ã•ã",  lang:"en-AU", pitch:0.92, rate:0.85,
    system:"You are Liam, a relaxed Australian guy. Use Australian expressions occasionally (mate, no worries). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be easygoing." },
  { id:"au_f",  emoji:"ğŸ‘©ğŸ½",  name:"Olivia", flag:"ğŸ‡¦ğŸ‡º Australian Female", trait:"é™½æ°—ãƒ»ãŠã—ã‚ƒã¹ã‚Š",  lang:"en-AU", pitch:1.1,  rate:0.85,
    system:"You are Olivia, a cheerful Australian woman. Use Australian expressions (mate, no worries, heaps). Keep ALL replies to 2-3 short sentences. Use simple vocabulary. Respond in English only. Be warm." }
];

// ============================================================
//  çŠ¶æ…‹å¤‰æ•°
// ============================================================
var myData         = null;
var fighters       = [];
var selAvatar      = AVATARS[0];
var chatHistory    = [];
var sessionTurns   = 0;
var sessionWords   = 0;
var sessionTranscript = "";
var recognition    = null;
var isRecording    = false;
var micBusy        = false;
var finalTrans     = "";
var synth          = window.speechSynthesis;
var voices         = [];
var apiKey         = "";

// ============================================================
//  åˆæœŸåŒ–
// ============================================================
window.onload = function() {
  // éŸ³å£°ãƒªã‚¹ãƒˆå–å¾—
  function loadVoices() { voices = synth.getVoices(); }
  loadVoices();
  if (synth.onvoiceschanged !== undefined) { synth.onvoiceschanged = loadVoices; }

  // ä¿å­˜æ¸ˆã¿APIã‚­ãƒ¼ã‚’localStorageã‹ã‚‰å¾©å…ƒ
  var saved = localStorage.getItem('eikaiwa_apikey');
  if (saved) document.getElementById('apiKeyInput').value = saved;

  // ã‚¢ãƒã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
  buildAvatarGrid();

  // GASã‹ã‚‰åç°¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å­¦å¹´ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ§‹ç¯‰
  loadAllStudents();
};

// ============================================================
//  GASã‹ã‚‰å…¨ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆJSONPæ–¹å¼ â€” CORSå•é¡Œã‚’å®Œå…¨å›é¿ï¼‰
// ============================================================
function loadAllStudents() {
  document.getElementById('loadStatus').innerText = 'åç°¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  gasJsonp("getAllStudents", null, function(data) {
    fighters = data;
    var grades = [];
    data.forEach(function(s) {
      if (grades.indexOf(s.grade) === -1) grades.push(s.grade);
    });
    grades.sort();
    var sel = document.getElementById('gradeSel');
    sel.innerHTML = '<option value="">ğŸ“š å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
    grades.forEach(function(g) { sel.add(new Option(g + "å¹´ç”Ÿ", g)); });
    document.getElementById('loadStatus').innerText = '';
  }, function(e) {
    document.getElementById('loadStatus').innerText = 'âš ï¸ åç°¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e;
  });
}

// ============================================================
//  JSONPæ±ç”¨é–¢æ•°ï¼ˆGASã¨ã®é€šä¿¡ã«ä½¿ç”¨ï¼‰
//  GETã¯JSONPã€POSTã¯GETãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«JSONã‚’ä¹—ã›ã‚‹
// ============================================================
var jsonpCallbackCounter = 0;
function gasJsonp(action, postData, onSuccess, onError) {
  var cbName = '__gasCb' + (++jsonpCallbackCounter);
  var script = document.createElement('script');
  var timer = null;

  window[cbName] = function(data) {
    clearTimeout(timer);
    script.remove();
    delete window[cbName];
    onSuccess(data);
  };

  timer = setTimeout(function() {
    script.remove();
    delete window[cbName];
    onError('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10ç§’ï¼‰');
  }, 10000);

  var url = GAS_URL + "?action=" + encodeURIComponent(action) + "&callback=" + cbName;
  if (postData) {
    url += "&data=" + encodeURIComponent(JSON.stringify(postData));
  }
  script.src = url;
  document.head.appendChild(script);
}

function loadClasses() {
  var g = document.getElementById('gradeSel').value;
  var classSel = document.getElementById('classSel');
  var nameSel  = document.getElementById('nameSel');
  classSel.style.display = 'none';
  nameSel.style.display  = 'none';
  if (!g) return;
  var classes = [];
  fighters.forEach(function(s) {
    if (String(s.grade) === String(g) && classes.indexOf(s.cls) === -1) classes.push(s.cls);
  });
  classes.sort();
  classSel.innerHTML = '<option value="">ğŸ« ã‚¯ãƒ©ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
  classes.forEach(function(c) { classSel.add(new Option(c + "çµ„", c)); });
  classSel.style.display = 'block';
}

function loadNames() {
  var g = document.getElementById('gradeSel').value;
  var c = document.getElementById('classSel').value;
  var nameSel = document.getElementById('nameSel');
  nameSel.style.display = 'none';
  if (!c) return;
  var filtered = fighters.filter(function(s){ return String(s.grade)===String(g) && String(s.cls)===String(c); });
  nameSel.innerHTML = '<option value="">ğŸ‘¤ åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
  filtered.forEach(function(s){ nameSel.add(new Option(s.name, s.id)); });
  nameSel.style.display = 'block';
}

function goToAvatarSelect() {
  var id = document.getElementById('nameSel').value;
  if (!id) { alert("åå‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼"); return; }

  // APIã‚­ãƒ¼ç¢ºèªãƒ»ä¿å­˜
  apiKey = document.getElementById('apiKeyInput').value.trim();
  if (!apiKey || !apiKey.startsWith('sk-ant-')) {
    alert("æ­£ã—ã„Anthropicã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\nï¼ˆsk-ant-... ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ã§ã™ï¼‰");
    return;
  }
  localStorage.setItem('eikaiwa_apikey', apiKey);

  myData = fighters.find(function(f){ return String(f.id) === String(id); });
  if (!myData) { alert("ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }
  showScreen('avatar');
}

// ============================================================
//  ç”»é¢åˆ‡æ›¿
// ============================================================
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
  document.getElementById('screen-' + name).classList.add('active');
}

// ============================================================
//  ã‚¢ãƒã‚¿ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
// ============================================================
function buildAvatarGrid() {
  var grid = document.getElementById('avatarGrid');
  grid.innerHTML = '';
  AVATARS.forEach(function(av, i) {
    var div = document.createElement('div');
    div.className = 'av-card' + (i === 0 ? ' sel' : '');
    div.innerHTML =
      '<div class="av-em">' + av.emoji + '</div>' +
      '<div class="av-nm">' + av.name  + '</div>' +
      '<div class="av-fl">' + av.flag  + '</div>' +
      '<div class="av-tr">' + av.trait + '</div>';
    div.addEventListener('click', (function(avatar, el){
      return function(){
        document.querySelectorAll('.av-card').forEach(function(c){ c.classList.remove('sel'); });
        el.classList.add('sel');
        selAvatar = avatar;
      };
    })(av, div));
    grid.appendChild(div);
  });
}

// ============================================================
//  ä¼šè©±ã‚¹ã‚¿ãƒ¼ãƒˆ
// ============================================================
function startConversation() {
  chatHistory = []; sessionTurns = 0; sessionWords = 0; sessionTranscript = "";
  document.getElementById('chatBox').innerHTML = '';
  micBusy = false;

  document.getElementById('hdAvaIcon').innerText = selAvatar.emoji;
  document.getElementById('hdAvaName').innerText = selAvatar.name;
  document.getElementById('hdAvaDesc').innerText = selAvatar.flag;
  document.getElementById('stSessions').innerText  = (Number(myData.totalSessions) || 0) + 1;
  document.getElementById('stMaxTurns').innerText  = myData.maxTurns || 0;
  document.getElementById('liveText').innerText = 'ğŸ¤ ã€Œè©±ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è‹±èªã§è©±ã—ã¦ãã ã•ã„';
  showScreen('chat');
  updateStats();

  var opening = "Hello! I'm " + selAvatar.name + ". Nice to meet you! What's your name?";
  addBubble('ai', opening);
  speakText(opening);
}

// ============================================================
//  ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ â€” getUserMediaä¸ä½¿ç”¨ãƒ»ç›´æ¥SpeechRecognition
// ============================================================
function handleMic() {
  if (micBusy) return;
  if (isRecording) { stopRec(); return; }

  var Speech = window.webkitSpeechRecognition || window.SpeechRecognition;
  if (!Speech) {
    alert("éŸ³å£°èªè­˜ã¯Safariï¼ˆiPhoneï¼‰ã¾ãŸã¯Chromeï¼ˆPC/Androidï¼‰ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚");
    return;
  }
  synth.cancel();
  recognition = new Speech();
  recognition.lang = 'en-US';
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    isRecording = true; finalTrans = "";
    document.getElementById('micBtn').innerText = "ğŸ›‘ æ­¢ã‚ã¦é€ä¿¡";
    document.getElementById('micBtn').classList.add('rec');
    document.getElementById('liveText').innerText = "ğŸ‘‚ èã„ã¦ã„ã¾ã™â€¦è©±ã—çµ‚ã‚ã£ãŸã‚‰ã€Œæ­¢ã‚ã¦é€ä¿¡ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";
  };

  recognition.onresult = function(e) {
    var interim = ""; finalTrans = "";
    for (var i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalTrans += e.results[i][0].transcript + " ";
      else interim += e.results[i][0].transcript;
    }
    document.getElementById('liveText').innerText = "ğŸ¤ " + (finalTrans || interim);
  };

  recognition.onerror = function(e) {
    console.log("SpeechError:", e.error);
    if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
      document.getElementById('liveText').innerText =
        "âš ï¸ ãƒã‚¤ã‚¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n" +
        "ã€iPhoneã€‘è¨­å®š â†’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ â†’ ãƒã‚¤ã‚¯ â†’ Safari/Chrome ã‚’ã‚ªãƒ³ã«\n" +
        "ã€Androidã€‘ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ã‚¢ã‚¤ã‚³ãƒ³ â†’ ãƒã‚¤ã‚¯ â†’ è¨±å¯";
    } else if (e.error === 'no-speech') {
      document.getElementById('liveText').innerText = "âš ï¸ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã©ã†ãã€‚";
    } else if (e.error === 'network') {
      document.getElementById('liveText').innerText = "âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    } else {
      document.getElementById('liveText').innerText = "âš ï¸ ã‚¨ãƒ©ãƒ¼(" + e.error + ")ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    }
    resetMicBtn(); isRecording = false;
  };

  recognition.onend = function() {
    // continuous=trueã§ã‚‚æ­¢ã¾ã‚‹ã“ã¨ãŒã‚ã‚‹ï¼ˆSafariå¯¾ç­–ï¼šå†èµ·å‹•ï¼‰
    if (isRecording) {
      try { recognition.start(); } catch(ex) { /* æ—¢ã«èµ·å‹•ä¸­ã®å ´åˆã¯ç„¡è¦– */ }
    }
  };

  try { recognition.start(); }
  catch(e) {
    document.getElementById('liveText').innerText = "âš ï¸ ãƒã‚¤ã‚¯ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚";
  }
}

function stopRec() {
  isRecording = false;
  if (recognition) { recognition.onend = null; recognition.stop(); }
  resetMicBtn();

  var text = finalTrans.trim();
  if (!text) {
    document.getElementById('liveText').innerText = "âš ï¸ èãå–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  var words = text.replace(/[.,?!'"]/g,"").split(/\s+/).filter(function(w){ return w.length>0; });
  sessionWords += words.length;
  sessionTurns++;
  sessionTranscript += "[Turn " + sessionTurns + "] You: " + text + "\n";
  updateStats();
  addBubble('me', text);
  document.getElementById('liveText').innerText = "ğŸ¤” " + selAvatar.name + " ãŒè€ƒãˆã¦ã„ã¾ã™â€¦";

  micBusy = true;
  document.getElementById('micBtn').disabled = true;
  document.getElementById('micBtn').innerText = "â³ å¾…æ©Ÿä¸­â€¦";

  chatHistory.push({ role:"user", content: text });
  var loadId = addLoadingBubble();

  // Anthropic APIã‚’ç›´æ¥å‘¼ã³å‡ºã™
  callAnthropicAPI(text, function(reply){
    removeLoadingBubble(loadId);
    chatHistory.push({ role:"assistant", content: reply });
    sessionTranscript += "[Turn " + sessionTurns + "] " + selAvatar.name + ": " + reply + "\n";
    addBubble('ai', reply);
    speakText(reply);
    document.getElementById('liveText').innerText = 'ğŸ¤ ã€Œè©±ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è‹±èªã§è©±ã—ã¦ãã ã•ã„';
    micBusy = false;
    document.getElementById('micBtn').disabled = false;
    resetMicBtn();
  }, function(err){
    removeLoadingBubble(loadId);
    document.getElementById('liveText').innerText = "âš ï¸ AIã‚¨ãƒ©ãƒ¼: " + err;
    chatHistory.pop();
    micBusy = false;
    document.getElementById('micBtn').disabled = false;
    resetMicBtn();
  });
}

function resetMicBtn() {
  document.getElementById('micBtn').innerText = "ğŸ¤ è©±ã™";
  document.getElementById('micBtn').classList.remove('rec');
}

// ============================================================
//  Anthropic API ç›´æ¥å‘¼ã³å‡ºã—ï¼ˆGASä¸ä½¿ç”¨ï¼‰
// ============================================================
function callAnthropicAPI(userMessage, onSuccess, onError) {
  var messages = chatHistory.slice(0, -1); // æœ€å¾Œã®userãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯historyã‹ã‚‰é™¤å¤–ï¼ˆä¸‹ã§è¿½åŠ ï¼‰
  messages.push({ role:"user", content: userMessage });

  fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type":        "application/json",
      "x-api-key":           apiKey,
      "anthropic-version":   "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"  // ãƒ–ãƒ©ã‚¦ã‚¶ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼
    },
    body: JSON.stringify({
      model:      "claude-haiku-4-5-20251001",
      max_tokens: 200,
      system:     selAvatar.system,
      messages:   messages
    })
  })
  .then(function(r){ return r.json(); })
  .then(function(data){
    if (data.error) { onError(data.error.message); return; }
    onSuccess(data.content[0].text);
  })
  .catch(function(e){ onError(e.message); });
}

// ============================================================
//  å˜èªç¿»è¨³ï¼ˆAnthropic APIç›´æ¥ï¼‰
// ============================================================
function translateWord(word, callback) {
  fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type":        "application/json",
      "x-api-key":           apiKey,
      "anthropic-version":   "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"
    },
    body: JSON.stringify({
      model:      "claude-haiku-4-5-20251001",
      max_tokens: 60,
      messages: [{ role:"user", content:"ã€Œ" + word + "ã€ã®æ—¥æœ¬èªã®æ„å‘³ã‚’ã€Œå˜èª â†’ æ„å‘³ï¼ˆå“è©ï¼‰ã€ã®å½¢å¼ã§ä¸€è¡Œã ã‘ç­”ãˆã¦ãã ã•ã„ã€‚" }]
    })
  })
  .then(function(r){ return r.json(); })
  .then(function(data){ callback(data.content[0].text.trim()); })
  .catch(function(){ callback(word + " â†’ (ç¿»è¨³ã‚¨ãƒ©ãƒ¼)"); });
}

// ============================================================
//  ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ–ãƒ«
// ============================================================
var loadIdCounter = 0;
function addLoadingBubble() {
  var id = ++loadIdCounter;
  var box = document.getElementById('chatBox');
  var wrap = document.createElement('div');
  wrap.className = 'bwrap'; wrap.id = 'ld-' + id;
  wrap.innerHTML = '<div class="bava">' + selAvatar.emoji + '</div>' +
    '<div class="bubble ai loading-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
  box.appendChild(wrap); box.scrollTop = box.scrollHeight;
  return id;
}
function removeLoadingBubble(id) {
  var el = document.getElementById('ld-' + id);
  if (el) el.remove();
}

// ============================================================
//  ãƒãƒ–ãƒ«è¿½åŠ 
// ============================================================
function addBubble(who, text) {
  var box  = document.getElementById('chatBox');
  var wrap = document.createElement('div');
  wrap.className = 'bwrap ' + who;
  var avaDiv = document.createElement('div');
  avaDiv.className = 'bava';
  avaDiv.innerText = (who === 'ai') ? selAvatar.emoji : 'ğŸ§‘â€ğŸ“';
  var bub = document.createElement('div');
  bub.className = 'bubble ' + who;

  if (who === 'ai') {
    text.split(/(\s+)/).forEach(function(token) {
      if (token.trim().length > 0) {
        var btn = document.createElement('button');
        btn.className = 'wbtn'; btn.innerText = token;
        btn.title = "ã‚¿ãƒƒãƒ—ã§æ—¥æœ¬èªè¨³";
        btn.addEventListener('click', (function(w, el){
          return function(e){
            e.stopPropagation();
            if (el.querySelector('.transl')) return;
            var clean = w.replace(/[.,?!'"()]/g,"");
            if (!clean) return;
            translateWord(clean, function(jp){
              var tip = document.createElement('span');
              tip.className = 'transl'; tip.innerText = jp;
              el.appendChild(tip);
            });
          };
        })(token, btn));
        bub.appendChild(btn);
      } else {
        bub.appendChild(document.createTextNode(token));
      }
    });
    var wc = text.replace(/[.,?!'"]/g,"").split(/\s+/).filter(function(w){ return w.length>0; }).length;
    var badge = document.createElement('div');
    badge.className = 'word-badge'; badge.innerText = wc + " words";
    bub.appendChild(badge);
  } else {
    bub.innerText = text;
  }

  if (who === 'ai') { wrap.appendChild(avaDiv); wrap.appendChild(bub); }
  else              { wrap.appendChild(bub); wrap.appendChild(avaDiv); }
  box.appendChild(wrap); box.scrollTop = box.scrollHeight;
}

// ============================================================
//  TTS
// ============================================================
function speakText(text) {
  if (!synth) return;
  synth.cancel();
  setTimeout(function(){
    var u = new SpeechSynthesisUtterance(text);
    u.lang = selAvatar.lang; u.pitch = selAvatar.pitch; u.rate = selAvatar.rate;
    if (voices.length === 0) voices = synth.getVoices();
    var country = selAvatar.lang.split('-')[1];
    var matched = voices.find(function(v){ return v.lang === selAvatar.lang; })
                || voices.find(function(v){ return v.lang.includes(country); })
                || voices.find(function(v){ return v.lang.startsWith('en'); });
    if (matched) u.voice = matched;
    synth.speak(u);
  }, 150);
}

// ============================================================
//  çµ±è¨ˆæ›´æ–°
// ============================================================
function updateStats() {
  document.getElementById('stTurns').innerText = sessionTurns;
  document.getElementById('stWords').innerText = sessionWords;
}

// ============================================================
//  ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ»GASã«ä¿å­˜
// ============================================================
function endSession() {
  synth.cancel();
  if (isRecording) { isRecording = false; if (recognition) { recognition.onend=null; recognition.stop(); } }

  var newMaxTurns   = Math.max(Number(myData.maxTurns) || 0, sessionTurns);
  var newTotalWords = (Number(myData.totalWords) || 0) + sessionWords;

  document.getElementById('rTurns').innerText    = sessionTurns;
  document.getElementById('rWords').innerText    = sessionWords;
  document.getElementById('rSessions').innerText = (Number(myData.totalSessions) || 0) + 1;
  document.getElementById('rMaxTurns').innerText = newMaxTurns + " ã‚¿ãƒ¼ãƒ³";
  document.getElementById('rTotalWords').innerText = newTotalWords + " èª";

  var emoji = "ğŸŒ±", comment = "æ¬¡ã¯ã‚‚ã£ã¨è©±ã—ã¦ã¿ã‚ˆã†ï¼Keep going!";
  if      (sessionTurns >= 15) { emoji="ğŸ†"; comment="ç´ æ™´ã‚‰ã—ã„ï¼ãŸãã•ã‚“è‹±èªã§è©±ã›ã¾ã—ãŸï¼Excellent!"; }
  else if (sessionTurns >= 10) { emoji="ğŸ¥‡"; comment="ã¨ã¦ã‚‚ã‚ˆãè©±ã›ã¾ã—ãŸï¼Great job!"; }
  else if (sessionTurns >= 6)  { emoji="ğŸ¥ˆ"; comment="ã„ã„èª¿å­ï¼Good job!"; }
  else if (sessionTurns >= 3)  { emoji="ğŸ¥‰"; comment="ã¾ãšã¾ãšã§ã™ï¼Nice try!"; }
  document.getElementById('rEmoji').innerText   = emoji;
  document.getElementById('rComment').innerText = comment;
  document.getElementById('saveStatus').innerText = "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­â€¦";

  showScreen('result');

  // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’JSONPã§é€ä¿¡ã—ã¦ä¿å­˜
  var grade = document.getElementById('gradeSel').value;
  var cls   = document.getElementById('classSel').value;

  gasJsonp("recordSession", {
    grade:      grade,
    cls:        cls,
    id:         myData.id,
    name:       myData.name,
    words:      sessionWords,
    turns:      sessionTurns,
    transcript: sessionTranscript
  }, function(res) {
    document.getElementById('saveStatus').innerText = res.status === "OK" ? "âœ… ä¿å­˜å®Œäº†ï¼" : "âš ï¸ ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + res.message;
    if (res.status === "OK") {
      myData.totalSessions = (Number(myData.totalSessions)||0) + 1;
      myData.totalWords    = newTotalWords;
      myData.maxTurns      = newMaxTurns;
    }
  }, function(e) {
    document.getElementById('saveStatus').innerText = "âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e;
  });
}
</script>
</body>
</html>
